---
title: "BTC-Forecast"
author: "JDRK"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE)

datef<-"`r Sys.Date()`"

library(stringr)
library(janitor)
library(tidyr)
library(dplyr)
library(formattable)
library(DT)
library(gt)
library(lubridate)
library(quantmod)
library(pacman)
library(scales)
library(data.table)
library(openxlsx)
library(readxl) 
library(tibble)
library(ggplot2)
library(plotly)
library(tseries)
library(forecast)


getSymbols("BTC-USD",from="2015-01-01")

btc<-rownames_to_column(data.frame(`BTC-USD`))


btc<-
btc %>% select(rowname,BTC.USD.Adjusted) %>% 
rename(date=rowname,price=BTC.USD.Adjusted) %>% mutate(date=ymd(date))%>% 
mutate(mn=round_date(date,"month"),wk=round_date(date,"week")) 

#--------------------------------------------------------------------------
mn<-btc %>% group_by(mn) %>% summarize(price=mean(price))

#Last

mnts<-ts(mn$price,start =c(2015,1) ,end =c(2023,7) ,frequency = 12)


autoplot(decompose(diff(mnts)))


mna<-auto.arima(mnts)

mnf<-forecast(mna,h = 13)

autoplot(mnf)

detect_last<-
cbind(rownames_to_column(data.frame(mnf))
,mn[c(104:116),] ) %>% select(mn,price,Hi.80,Hi.95) %>% 
mutate(detect_last= (Hi.95/price)-1)

detect_last_gt<-
detect_last %>% gt() %>% cols_label_with(columns =c(1:5) ,fn = toupper) %>% cols_align(align = "center") %>% fmt_number(columns = c(2:4),decimals = 2) %>% opt_stylize(style = 3) %>% fmt_percent(columns = 5,decimals = 2) %>% tab_row_group(rows = mn < "2023-12-01",label = "2023",others_label = "2024") %>% tab_style(style = list(cell_text(color="black")),locations = cells_body()) %>% tab_style(style = list(cell_fill(color="gray"),cell_text(weight = "bold")),locations = cells_row_groups()) %>% tab_style(style =list(cell_text(weight = "bold")) ,locations =cells_column_labels())


detect_last_chart<-
detect_last %>% mutate(mn=as.POSIXct(mn)) %>% select(mn,price,Hi.80,Hi.95)%>% 
pivot_longer(!mn,names_to = "cat",values_to = "price") %>% 
ggplot(aes(x=mn,y = price,color=cat,group=cat))+geom_line()+
scale_x_datetime(date_breaks ="month" ,date_labels = "%b-%Y")+theme_bw()+
labs(x="",y="")+
scale_y_continuous(breaks = c(25000,35000,45000,55000,65000,75000))+
theme(axis.text.x = element_text(face = "bold",size=10,color="black",angle = 90),
axis.text.y = element_text(face = "bold",size=10,color="black"))


#Real

mrts<-ts(mn$price,start =c(2015,1) ,end =c(2024,8) ,frequency = 12)

mra<-auto.arima(mrts)

mrf<-forecast(mra,h = 12)

autoplot(mrf)

nextf<-data.frame(mn=seq(as.Date("2024-09-1"),by="month",len=12))

mn_add_gt<-
cbind(rownames_to_column(data.frame(mrf)),nextf) %>% 
select(mn,Point.Forecast,Lo.95,Hi.95,Hi.80,Lo.80) %>% gt() %>% 
tab_header("Forecast BTC Prices For Year") %>% 
cols_label_with(columns = everything(),fn = toupper) %>% 
cols_align(align = "center") %>% tab_spanner(label = "Ranges",columns = c(3:6)) %>%
opt_align_table_header(align = "center") %>% 
opt_stylize(style = 3,color = "blue") %>%
tab_row_group(rows = mn<="2024-12-01",label = "2024",others_label = "2025") %>%
tab_style(style = list(cell_text(color="black",align = "center")),
locations = cells_body()) %>% tab_style(style =list(cell_text(weight = "bold")) ,
locations = cells_column_labels()) %>% 
tab_style(style = list(cell_text(weight = "bold")),
locations = cells_column_spanners()) %>% tab_style(style =list(cell_fill("#fdcb6e"),
cell_text(weight = "bold")) ,locations = cells_title()) %>%
grand_summary_rows(columns = c(2:6),fns = list( AVG=~mean(.)) ) %>%
fmt_number(columns = c(2:6),decimals = 2) %>% 
fmt_date(columns = 1,date_style = "yMMMM") %>% 
tab_style(style =list(cell_fill("black"),cell_text(color="white",weight = "bold")) 
,locations = cells_grand_summary()) %>% 
tab_style(style =list(cell_fill(color="black"),cell_text(color="white")) ,
locations = cells_stub_grand_summary())


mn_add_chart<-
rbind(mn,nextf %>% mutate(price=NA)) %>% left_join((
cbind(rownames_to_column(data.frame(mrf)),nextf) %>% 
select(mn,Point.Forecast,Lo.95,Hi.95,Hi.80,Lo.80)),by="mn") %>%
pivot_longer(!mn,names_to ="cat" ,values_to = "price") %>% 
mutate(mn=as.POSIXct(mn))%>% filter(mn>"2017-12-31") %>% 
ggplot(aes(x=mn,y=price,color=cat,group=cat))+geom_line(size=0.7)+
scale_fill_brewer(palette = "Set1")+
scale_x_datetime(date_breaks ="3 month" ,date_labels = "%b-%Y")+
theme_bw()+
theme(axis.text.x = element_text(angle = 90,color="black",size=10),
axis.text.y = element_text(color="black",size=10),
plot.title = element_text(face = "bold",colour = "brown",size = 15),
plot.subtitle = element_text(face = "bold.italic",colour = "black"))+labs(x="",y="")

```


 
## {.tabset}

### Last_Year


Data Periods From: Jan 2015 To Aug 2023


```{r}
ggplotly( detect_last_chart,width = 900)
```

### Last_Year_TBL
```{r}
detect_last_gt
```

### Next Year Chart


Removes Prices Less Than 10K To Focus Ranges Betweek 25K - 75K 

```{r}
ggplotly( mn_add_chart,width = 900)
```

 
### Next Year TBL
```{r}
mn_add_gt
```

 
 
 
 
 
 
 
 
 
 
 
 
 
 